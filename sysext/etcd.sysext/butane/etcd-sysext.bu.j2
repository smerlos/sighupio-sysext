variant: flatcar
version: 1.1.0

# ==============================================================================
# ETCD SYSTEM EXTENSION - BUTANE CONFIGURATION
# Generated by Ansible
# Template: etcd-sysext.bu.j2
#
# Node: {{ etcd_name | default(inventory_hostname) }}
# ==============================================================================

storage:
  directories:
    # etcd data directory
    - path: /var/lib/etcd
      mode: 0700
      user:
        name: etcd
      group:
        name: etcd

    # etcd configuration directory
    - path: /etc/etcd
      mode: 0755

    # etcd PKI directory
    - path: {{ etcd_certs_dir | default('/etc/etcd/pki') }}
      mode: 0700
      user:
        name: etcd
      group:
        name: etcd

    # sysext storage directory
    - path: {{ etcd_sysext_storage_dir | default('/opt/extensions/etcd') }}
      mode: 0755

    # sysupdate config directory
    - path: /etc/sysupdate.etcd.d
      mode: 0755

  files:
    # ===========================================================================
    # SYSTEM EXTENSION IMAGE
    # ===========================================================================
    - path: {{ etcd_sysext_storage_dir | default('/opt/extensions/etcd') }}/etcd-{{ etcd_version | regex_replace('^v', '') }}-x86-64.raw
      mode: 0644
      contents:
        source: {{ etcd_sysext_download_url }}/etcd-{{ etcd_version | regex_replace('^v', '') }}-x86-64.raw

    # ===========================================================================
    # SYSUPDATE CONFIGURATION
    # ===========================================================================
    - path: /etc/sysupdate.etcd.d/etcd.conf
      mode: 0644
      contents:
        inline: |
          [Transfer]
          Verify=false

          [Source]
          Type=url-file
          Path={{ etcd_sysext_download_url }}/
          MatchPattern=etcd-@v-%a.raw

          [Target]
          InstancesMax=3
          Type=regular-file
          Path={{ etcd_sysext_storage_dir | default('/opt/extensions/etcd') }}
          CurrentSymlink={{ etcd_sysext_link | default('/etc/extensions/etcd.raw') }}

    # ===========================================================================
    # ETCD ENVIRONMENT CONFIGURATION
    # ===========================================================================
    - path: /etc/etcd/etcd.env
      mode: 0644
      contents:
        inline: |
          # etcd Environment Configuration
          # Node: {{ etcd_name | default(inventory_hostname) }}
          
          # Node Identity
          ETCD_NAME={{ etcd_name | default(inventory_hostname) }}
          ETCD_DATA_DIR={{ etcd_data_dir | default('/var/lib/etcd') }}
          
          # Clustering
          ETCD_INITIAL_CLUSTER={{ etcd_initial_cluster }}
          ETCD_INITIAL_CLUSTER_STATE={{ etcd_initial_cluster_state | default('new') }}
          ETCD_INITIAL_CLUSTER_TOKEN={{ etcd_initial_cluster_token | default('etcd-cluster') }}
          
          # Peer URLs
          ETCD_LISTEN_PEER_URLS=https://{{ etcd_address }}:{{ etcd_peer_port | default(2380) }}
          ETCD_INITIAL_ADVERTISE_PEER_URLS=https://{{ etcd_address }}:{{ etcd_peer_port | default(2380) }}
          
          # Client URLs
          ETCD_LISTEN_CLIENT_URLS=https://{{ etcd_address }}:{{ etcd_client_port | default(2379) }},https://127.0.0.1:{{ etcd_client_port | default(2379) }}
          ETCD_ADVERTISE_CLIENT_URLS=https://{{ etcd_address }}:{{ etcd_client_port | default(2379) }}
          
          # Metrics
          ETCD_LISTEN_METRICS_URLS=http://{{ etcd_address }}:{{ etcd_metrics_port | default(2381) }}
          
          # Server TLS
          ETCD_CERT_FILE={{ etcd_certs_dir | default('/etc/etcd/pki') }}/server.crt
          ETCD_KEY_FILE={{ etcd_certs_dir | default('/etc/etcd/pki') }}/server.key
          ETCD_TRUSTED_CA_FILE={{ etcd_certs_dir | default('/etc/etcd/pki') }}/ca.crt
          ETCD_CLIENT_CERT_AUTH=true
          
          # Peer TLS
          ETCD_PEER_CERT_FILE={{ etcd_certs_dir | default('/etc/etcd/pki') }}/peer.crt
          ETCD_PEER_KEY_FILE={{ etcd_certs_dir | default('/etc/etcd/pki') }}/peer.key
          ETCD_PEER_TRUSTED_CA_FILE={{ etcd_certs_dir | default('/etc/etcd/pki') }}/ca.crt
          ETCD_PEER_CLIENT_CERT_AUTH=true
          
          # Security
          ETCD_STRICT_RECONFIG_CHECK=true
          
          # Performance
          GOMAXPROCS={{ etcd_gomaxprocs | default(4) }}

    # ===========================================================================
    # ETCDCTL ENVIRONMENT
    # ===========================================================================
    - path: /etc/profile.d/etcdctl.sh
      mode: 0644
      contents:
        inline: |
          export ETCDCTL_API=3
          export ETCDCTL_CACERT={{ etcd_certs_dir | default('/etc/etcd/pki') }}/ca.crt
          export ETCDCTL_CERT={{ etcd_certs_dir | default('/etc/etcd/pki') }}/apiserver-etcd-client.crt
          export ETCDCTL_KEY={{ etcd_certs_dir | default('/etc/etcd/pki') }}/apiserver-etcd-client.key
          export ETCDCTL_DIAL_TIMEOUT=3s
          export ETCDCTL_ENDPOINTS=https://{{ etcd_client_address | default('127.0.0.1') }}:{{ etcd_client_port | default(2379) }}

  links:
    # Symlink to activate the system extension
    - path: {{ etcd_sysext_link | default('/etc/extensions/etcd.raw') }}
      target: {{ etcd_sysext_storage_dir | default('/opt/extensions/etcd') }}/etcd-{{ etcd_version | regex_replace('^v', '') }}-x86-64.raw
      hard: false

systemd:
  units:
    # Enable etcd service (provided by sysext)
    - name: etcd.service
      enabled: true

    # Sysupdate drop-in for automatic extension updates
    - name: systemd-sysupdate.service
      dropins:
        - name: etcd.conf
          contents: |
            [Service]
            ExecStartPre=/usr/bin/sh -c "readlink --canonicalize /etc/extensions/etcd.raw > /tmp/etcd"
            ExecStartPre=/usr/lib/systemd/systemd-sysupdate -C etcd update
            ExecStartPost=/usr/bin/sh -c "readlink --canonicalize /etc/extensions/etcd.raw > /tmp/etcd-new"
            ExecStartPost=/usr/bin/sh -c "if ! cmp --silent /tmp/etcd /tmp/etcd-new; then touch /run/reboot-required; fi"
